{% if monitoring.logging.log_format == 'json' %}
{
  "timestamp": "{{ log_timestamp }}",
  "monitoring_summary": {
    "total_proxies": {{ test_results | length }},
    "healthy_proxies": {{ test_results.values() | selectattr('status', 'equalto', 'HEALTHY') | list | length }},
    "unhealthy_proxies": {{ test_results.values() | selectattr('status', 'equalto', 'UNHEALTHY') | list | length }},
    "overall_success_rate": {{ (test_results.values() | map(attribute='successful_tests') | sum | float * 100 / test_results.values() | map(attribute='total_tests') | sum | float) | round(2) if test_results.values() | map(attribute='total_tests') | sum > 0 else 0 }}
  },
  "proxy_results": [
{% for proxy_name, proxy_data in test_results.items() %}
    {
      "proxy_name": "{{ proxy_name }}",
      "proxy_url": "{{ proxy_data.proxy_url }}",
      "status": "{{ proxy_data.status }}",
      "success_rate": {{ proxy_data.success_rate }},
      "successful_tests": {{ proxy_data.successful_tests }},
      "failed_tests": {{ proxy_data.failed_tests }},
      "total_tests": {{ proxy_data.total_tests }},
      "test_details": [
{% for test in proxy_data.test_details %}
        {
          "website": "{{ test.website }}",
          "url": "{{ test.url }}",
          "status": "{{ test.status }}",
          "status_code": {{ test.status_code }},
          "response_time_ms": {{ test.response_time }},
          "error_message": "{{ test.error_msg | default('') }}",
          "timestamp": "{{ test.timestamp }}"
        }{% if not loop.last %},{% endif %}
{% endfor %}
      ]
    }{% if not loop.last %},{% endif %}
{% endfor %}
  ]
}
{% else %}
===============================================================================
PROXY MONITORING REPORT
===============================================================================
Timestamp: {{ log_timestamp }}
Generated by: Ansible Proxy Monitoring System

SUMMARY:
--------
Total Proxies Monitored: {{ test_results | length }}
Healthy Proxies: {{ test_results.values() | selectattr('status', 'equalto', 'HEALTHY') | list | length }}
Unhealthy Proxies: {{ test_results.values() | selectattr('status', 'equalto', 'UNHEALTHY') | list | length }}
Overall Success Rate: {{ (test_results.values() | map(attribute='successful_tests') | sum | float * 100 / test_results.values() | map(attribute='total_tests') | sum | float) | round(2) if test_results.values() | map(attribute='total_tests') | sum > 0 else 0 }}%

DETAILED RESULTS:
-----------------
{% for proxy_name, proxy_data in test_results.items() %}

[{{ proxy_data.status }}] {{ proxy_name }}
{{ '-' * (proxy_name | length + 15) }}
Proxy URL: {{ proxy_data.proxy_url }}
Status: {{ proxy_data.status }}
Success Rate: {{ proxy_data.success_rate }}%
Tests: {{ proxy_data.successful_tests }}/{{ proxy_data.total_tests }} successful
Timestamp: {{ proxy_data.timestamp }}

Website Test Results:
{% for test in proxy_data.test_details %}
  â€¢ {{ test.website }} ({{ test.url }})
    Status: {{ test.status }}
    Response Time: {{ test.response_time if test.response_time != -1 else 'N/A' }}ms
    HTTP Code: {{ test.status_code if test.status_code != -1 else 'N/A' }}
{% if test.error_msg %}    Error: {{ test.error_msg }}{% endif %}
{% endfor %}
{% endfor %}

THRESHOLDS:
-----------
Maximum Response Time: {{ monitoring.thresholds.max_response_time }}ms
Minimum Success Rate: {{ monitoring.thresholds.min_success_rate }}%
Maximum Failure Rate: {{ monitoring.thresholds.max_failure_rate }}%

{% if test_results.values() | selectattr('status', 'equalto', 'UNHEALTHY') | list | length > 0 %}
ALERTS:
-------
The following proxies require attention:
{% for proxy_name, proxy_data in test_results.items() %}
{% if proxy_data.status == 'UNHEALTHY' %}
- {{ proxy_name }}: Success rate {{ proxy_data.success_rate }}% (below threshold {{ monitoring.thresholds.min_success_rate }}%)
{% endif %}
{% endfor %}
{% endif %}

===============================================================================
{% endif %}